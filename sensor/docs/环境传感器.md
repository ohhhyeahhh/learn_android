# 环境传感器

### 总述

Android 平台提供四种传感器，用来监控各种环境属性。您可以使用这些传感器来监控 Android 设备附近的相对环境湿度、照度、环境压力和环境温度。四种环境传感器都基于硬件，要使用它们，设备制造商必须将其内置到设备中。大多数设备制造商都会使用光传感器来控制屏幕亮度，除此之外，设备上并不一定具备环境传感器。因此，请务必在运行时验证环境传感器是否存在，然后再尝试从中获取数据。

大多数动态传感器和位置传感器会为每个 `SensorEvent` 返回传感器值的多维数组，而与之不同的是，环境传感器只为每个数据事件返回一个传感器值。例如，以°C 为单位的温度或以 hPa 为单位的压力。此外，动态传感器和位置传感器通常需要高通或低通滤波，而环境传感器一般不需要任何数据滤波或数据处理。表 1 总结了 Android 平台支持的环境传感器。

 **表 1.** Android 平台支持的环境传感器。

| 传感器                     | 传感器事件数据    | 度量单位    | 数据说明       |
| :------------------------- | :---------------- | :---------- | :------------- |
| `TYPE_AMBIENT_TEMPERATURE` | `event.values[0]` | °C          | 环境空气温度。 |
| `TYPE_LIGHT`               | `event.values[0]` | lx          | 照度。         |
| `TYPE_PRESSURE`            | `event.values[0]` | hPa 或 mbar | 环境空气压力。 |
| `TYPE_RELATIVE_HUMIDITY`   | `event.values[0]` | %           | 环境相对湿度。 |
| `TYPE_TEMPERATURE`         | `event.values[0]` | °C          | 设备温度。1    |

###  具体实现示例

从光、压力和温度传感器获取的原始数据通常不需要校准、滤波或修改。要从这些传感器获取数据，您需要先创建 SensorManager 类的实例

```
private SensorManager mSensorManager;
```

并用它来获取物理传感器的实例

```
//获取传感器管理对象
mSensorManager = (SensorManager)getSystemService(Context.SENSOR_SERVICE);

//获取传感器类型
mHumidity = mSensorManager.getDefaultSensor(Sensor.TYPE_RELATIVE_HUMIDITY);  //湿度传感器
mTemperature = mSensorManager.getDefaultSensor(Sensor.TYPE_AMBIENT_TEMPERATURE);  //温度传感器
mLight = mSensorManager.getDefaultSensor(Sensor.TYPE_LIGHT);  //光传感器
mPressure = mSensorManager.getDefaultSensor(Sensor.TYPE_PRESSURE);  //压力传感器
//获得控件
humidityView = (TextView) findViewById(R.id.humidity);  //湿度控件
temperatureView = (TextView) findViewById(R.id.temperature);  //温度控件
lightView = (TextView) findViewById(R.id.light);  //光强控件
pressureView = (TextView) findViewById(R.id.pressure);  //压力控件
```

然后，在 onResume() 方法中注册传感器监听器

onResume() 方法使用对 SensorManager 的引用通过 registerListener 方法注册传感器更新：

第一个参数是实现 SensorListener 接口的类的实例。

第二个参数是所需传感器的位掩码。在本例中，应用程序从 SENSOR_ORIENTATION 和 SENSOR_ACCELEROMETER 请求数据。

第三个参数是一个系统提示，指出应用程序更新传感器值所需的速度。

 

应用程序（活动）暂停后，需要注销侦听器，这样以后就不会再收到传感器更新。这通过 SensorManager 的 unregisterListener 方法实现。惟一的参数是 SensorListener 的实例。

 

在 registerListener 和 unregisterListener 方法调用中，应用程序使用关键字 this。注意类定义中的 implements 关键字，其中声明了该类实现 SensorListener 接口。这就是要将它传递到 registerListener 和 unregisterListener 的原因。

```
@Override
//监听传感器传回的数据
protected void onResume(){    
    super.onResume();
    mSensorManager.registerListener(this,mHumidity,SensorManager.SENSOR_DELAY_GAME
);
    mSensorManager.registerListener(this,mTemperature,SensorManager.SENSOR_DELAY_
GAME);    
    mSensorManager.registerListener(this,mLight,SensorManager.SENSOR_DELAY_GAME);     mSensorManager.registerListener(this,mPressure,SensorManager.SENSOR_DELAY_GAME
);
}
@Override
//取消监听
protected void onStop(){    
    super.onStop();    
    mSensorManager.unregisterListener(this);
}
```

SensorListener 必须实现两个方法 onSensorChange 和 onAccuracyChanged。示例应用程序不关心传感器的准确度，但关注传感器当前的 X、Y 和 Z 值。onAccuracyChanged 方法实质上不执行任何操作；它只在每次调用时添加一个日志项。

```
@Override
//当传感器的值改变时的回调方法
public void onSensorChanged(SensorEvent event){    
	float[] values = event.values;
    
	//获取传感器类型    
	int type = event.sensor.getType();    
	float h, t, l, p;    
	switch (type){        
		//湿度        
		case Sensor.TYPE_RELATIVE_HUMIDITY:           
        	h = event.values[0];            
        	humidityView.setText(h+" %");           
            break;        
        //温度        
        case Sensor.TYPE_AMBIENT_TEMPERATURE:            
        	t = event.values[0];            
        	temperatureView.setText(t+" ℃");            
        	break;        
        //光强        
        case Sensor.TYPE_LIGHT:            
       		l = event.values[0];            
       		lightView.setText(l+" lux");            
       		break;        
       	//压力        
       	case Sensor.TYPE_PRESSURE:            
       		p = event.values[0];            
       		pressureView.setText(p+" hPa");            
       		break;            
       		default:                
       			break;    
    }
}

@Override
//当传感器精度发生改变时的回调方法
public void onAccuracyChanged(Sensor sensor,int accuracy){
}
```

 

## 使用湿度传感器

您可以使用湿度传感器获取原始相对湿度数据，就像使用光、压力和温度传感器一样。但是，如果设备既有湿度传感器 (`TYPE_RELATIVE_HUMIDITY`)，也有温度传感器 (`TYPE_AMBIENT_TEMPERATURE`)，您可以使用这两个数据流来计算露点和绝对湿度。

#### 露点

露点是指在恒定气压下，一定体积的空气使水蒸气凝结成水而必须冷却到的温度。露点的计算公式如下所示：

![t_d(t,RH) = Tn · (ln(RH/100) + m·t/(T_n+t))/(m - [ln(RH/100%) + m·t/(T_n+t)])](https://developer.android.google.cn/images/guide/topics/sensors/dew_point.png)

- td = 以摄氏度为单位的露点温度
- t = 以摄氏度为单位的实际温度
- RH = 以百分比 (%) 表示的实际相对湿度
- m = 17.62
- Tn = 243.12

#### 绝对湿度

绝对湿度是一定体积的干燥空气中的水蒸气质量。绝对湿度以克/米3 为度量单位。绝对湿度的计算公式如下所示：

![d_v(t,RH) =  (RH/100) · A · exp(mt/(T_n+t)/(273.15 + t)](https://developer.android.google.cn/images/guide/topics/sensors/absolute_humidity.png)

- dv = 以克/米3 为单位的绝对湿度
- t = 以摄氏度为单位的实际温度
- RH = 以百分比 (%) 表示的实际相对湿度
- m = 17.62
- Tn = 243.12 摄氏度
- A = 6.112 hPa





***\*一些光强的数据\****

//  最强的光线强度（估计只有沙漠地带才能达到这个值）

public static final float LIGHT_SUNLIGHT_MAX = 120000.0f;

//  万里无云时阳光直射的强度

public static final float LIGHT_SUNLIGHT  =  110000.0f;

//  有阳光，但被云彩抵消了部分光线时的强度

public static final float LIGHT_SHADE  =  20000.0f;

//  多云时的光线强度   

 public static final float LIGHT_OVERCAST   = 10000.0f;

//  太阳刚刚升起时（日出）的光线强度

public static final float LIGHT_SUNRISE    = 400.0f;

//  在阴雨天，没有太阳时的光线强度

public static final float LIGHT_CLOUDY    = 100.0f;

//  夜晚有月亮时的光线强度

public static final float LIGHT_FULLMOON   = 0.25f;

//  夜晚没有月亮时的光线强度（当然，也不能有路灯，就是漆黑一片）

public static final float LIGHT_NO_MOON    = 0.001f;

 

 

***\*例子：通过光传感器改变背景颜色\****

public class MainActivity extends AppCompatActivity implements SensorEventListener {

 

  private SensorManager sm;

  private String TAG = "Rair";

  private RelativeLayout mainBg;

 

  @Override

  protected void onCreate(Bundle savedInstanceState) {

​    super.onCreate(savedInstanceState);

​    setContentView(R.layout.activity_main);

​    initView();

  }

 

  private void initView() {

​    mainBg = (RelativeLayout) findViewById(R.id.main_bg);

​    //1、获取SensorManager

​    sm = (SensorManager) getSystemService(Context.SENSOR_SERVICE);

​    //2、获取所有的Sensor，也可以获取某类型的所有传感器

​    List<Sensor> sensorList = sm.getSensorList(Sensor.TYPE_ALL);

​    for (Sensor sensor : sensorList) {

​      Log.i(TAG, sensor.getName());

​    }

​    //3、获取默认的光感传感器

​    Sensor defaultSensor = sm.getDefaultSensor(Sensor.TYPE_LIGHT);

​    //4、注册传感器监听器

​    sm.registerListener(this, defaultSensor, SensorManager.SENSOR_DELAY_FASTEST);

  }

 

  @Override

  public void onSensorChanged(SensorEvent event) {

​    float value = event.values[0];

​    Log.i(TAG, "light value" + value);

​    if (value >= 255) {

​      value = 255;

​    } else if (value <= 0) {

​      value = 0;

​    }

​    int rgb = Color.rgb((int) value, 110, (int) value);

​    mainBg.setBackgroundColor(rgb);

  }

 

  @Override

  public void onAccuracyChanged(Sensor sensor, int accuracy) {

 

  }

 

  @Override

  protected void onDestroy() {

​    super.onDestroy();

​    //5、注销传感器监听器

​    sm.unregisterListener(this);

  }

}